<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Full-Stack Blog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f3f4f6;
    }

    .ql-toolbar.ql-snow {
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
      border-color: #e5e7eb;
      background: #f9fafb;
    }

    .ql-container.ql-snow {
      border-bottom-left-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
      border-color: #e5e7eb;
      font-size: 16px;
    }

    .ql-editor {
      min-height: 200px;
    }
  </style>
</head>

<body class="text-gray-800">

  <header class="bg-indigo-700 shadow-lg sticky top-0 z-10">
    <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-white flex items-center gap-2">
        <span>üõ°Ô∏è</span> Admin Panel
      </h1>
      <a href="blog.html"
        class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-md transition">Public Blog</a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-6">
    <h2 class="text-3xl font-bold mb-8 text-indigo-900 border-b pb-4">Create New Post</h2>
    <div id="message-box" class="hidden p-4 mb-6 rounded-lg text-sm font-medium border"></div>

    <form id="new-post-form" class="bg-white p-8 rounded-xl shadow-xl space-y-6 border border-gray-100">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Post Title</label>
          <input id="title" required placeholder="e.g. How to learn React"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Slug URL</label>
          <input id="slug" required placeholder="e.g. how-to-learn-react"
            class="w-full p-3 border border-gray-300 bg-gray-50 rounded-lg focus:outline-none text-gray-500">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Category</label>
          <select id="category" required
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
            <option value="">Select Category</option>
            <option value="social-media-recovery">Social Media Recovery</option>
            <option value="copyright-removal">Copyright Removal</option>
            <option value="username-claim">Username Claim</option>
            <option value="verification">Verification</option>
            <option value="instagram-collab">Instagram Collaboration</option>
            <option value="whatsapp-marketing">WhatsApp Marketing</option>
          </select>
        </div>

      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Feature Image</label>
        <input type="file" id="imageFile" accept="image/*"
          class="w-full p-2 border border-gray-300 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Content</label>
        <p class="text-xs text-gray-500 mb-2">üí° Tip: To edit a link, click it once. To visit the link, click the URL in
          the popup.</p>
        <div id="editor-container" class="bg-white"></div>
      </div>

      <div class="flex items-center space-x-2 pt-2">
        <input type="checkbox" id="published" checked
          class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
        <label for="published" class="text-gray-700 font-medium">Publish immediately</label>
      </div>

      <button type="submit"
        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5">
        üöÄ Create Post
      </button>
    </form>

    <div class="mt-12 border-t pt-8">
      <h2 class="text-3xl font-bold mb-6 text-indigo-900">Manage Posts</h2>

      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <table class="min-w-full leading-normal">
          <thead>
            <tr>
              <th
                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                Title
              </th>
              <th
                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                Date
              </th>
              <th
                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody id="admin-posts-list">
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // --- Configuration ---
    const API_BASE_URL = "https://account-recovery-app.onrender.com/api/posts";

    // --- Initialize Quill ---
    // We removed the complex CustomLink and Handlers. 
    // The default Quill setup handles links perfectly.
    var quill = new Quill('#editor-container', {
      theme: 'snow',
      placeholder: 'Write something amazing...',
      modules: {
        toolbar: {
          container: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            ['link', 'code-block', 'blockquote'],
            [{ 'color': [] }, { 'background': [] }],
            ['clean']
          ],
          handlers: {
            link: function () {
              const range = this.quill.getSelection();
              if (range == null || range.length === 0) {
                alert("Please select text or click OK to add a new link");
              }
              // Prompt for URL
              const url = prompt("Enter the URL for the link (include http:// or https://):");
              if (!url) return; // exit if empty

              // Prompt for display text
              let text = "";
              if (range.length === 0) {
                text = prompt("Enter the text for the link:");
                if (!text) return;
                this.quill.insertText(range.index, text, 'link', url);
              } else {
                // Apply link to selected text
                this.quill.format('link', url);
              }
            }
          }
        }
      }
    });

    // --- Form Logic ---
    const form = document.getElementById("new-post-form");
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    const messageBox = document.getElementById("message-box");

    // Auto-generate slug from title
    titleInput.addEventListener('input', () => {
      const slug = titleInput.value.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, "-");
      slugInput.value = slug;
    });

    function showMessage(msg, type = 'success') {
      messageBox.textContent = msg;
      if (type === 'success') {
        messageBox.className = 'p-4 mb-6 rounded-lg text-sm font-medium border bg-green-50 text-green-800 border-green-200';
      } else {
        messageBox.className = 'p-4 mb-6 rounded-lg text-sm font-medium border bg-red-50 text-red-800 border-red-200';
      }
      messageBox.classList.remove('hidden');
      setTimeout(() => messageBox.classList.add('hidden'), 5000);
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();

      // Check content length
      if (quill.getText().trim().length === 0) {
        showMessage("Content cannot be empty!", "error");
        return;
      }

      const formData = new FormData();
      formData.append('title', titleInput.value);
      formData.append('slug', slugInput.value);
      formData.append("category", document.getElementById("category").value);
      // Get HTML content
      formData.append('content', quill.root.innerHTML);

      formData.append('published', document.getElementById('published').checked);

      const fileInput = document.getElementById('imageFile');
      if (fileInput.files[0]) {
        formData.append('image', fileInput.files[0]);
      }

      try {
        const res = await fetch(API_BASE_URL, { method: "POST", body: formData });
        if (!res.ok) throw new Error("Error creating post");

        showMessage("Post created successfully!", "success");
        form.reset();
        quill.setContents([]);
      } catch (err) {
        console.error(err);
        showMessage("Error creating post!", "error");
      }
    });

    // ... existing initialization code ...

    const postsListContainer = document.getElementById('admin-posts-list');
    // This key must match what you put in the Backend Middleware
    const ADMIN_KEY = 'mysecret123';

    // 1. Function to Fetch and Display Posts
    async function fetchAdminPosts() {
      try {
        const res = await fetch(API_BASE_URL); // Uses your existing GET route
        const posts = await res.json();

        if (posts.length === 0) {
          postsListContainer.innerHTML = '<tr><td colspan="3" class="p-5 text-center">No posts found.</td></tr>';
          return;
        }

        postsListContainer.innerHTML = posts.map(post => `
            <tr>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap font-medium">${post.title}</p>
                    <p class="text-gray-500 text-xs">${post.slug}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <p class="text-gray-900 whitespace-no-wrap">${new Date(post.createdAt).toLocaleDateString()}</p>
                </td>
                <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                    <button onclick="deletePost(${post.id})" class="text-red-600 hover:text-red-900 transition font-bold bg-red-100 px-3 py-1 rounded">
                        Delete
                    </button>
                </td>
            </tr>
        `).join('');

      } catch (error) {
        console.error("Error fetching posts:", error);
      }
    }



    // Function to Delete Post
    window.deletePost = async (id) => {
      if (!confirm("Are you sure you want to delete this post?")) return;

      // 1. RETRIEVE TOKEN (Assumes you saved it as 'authToken' during login)
      const token = localStorage.getItem('authToken');

      if (!token) {
        alert("You are not logged in!");
        window.location.href = 'login.html'; // Redirect to login
        return;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/${id}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            // 2. SEND TOKEN IN HEADER
            'Authorization': `Bearer ${token}`
          }
        });

        if (res.ok) {
          // Success
          alert("Post deleted successfully");
          fetchAdminPosts(); // Refresh the table
        } else {
          // Handle Errors (401 Unauthorized or 403 Forbidden)
          const data = await res.json();
          alert(data.message || "Failed to delete");
        }
      } catch (error) {
        console.error(error);
        alert("Server error");
      }
    };
    // 3. Load posts when page loads
    document.addEventListener('DOMContentLoaded', () => {
      fetchAdminPosts();
    });



  </script>
</body>

</html>